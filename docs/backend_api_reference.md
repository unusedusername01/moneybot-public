# Backend API Reference

This reference catalogues every public HTTP and WebSocket surface exposed by `src/langgraph_workflow/app.py`. Use it in tandem with the autogenerated Pydantic JSON schema (see `MessagePayload.export_json_schema`) and the frontend contract in `src/webapp/src/types/api.ts`.

## Base URL and Presets

- Default host/port: `http://127.0.0.1:8000`.
- CI preset (`config/ci.test.yml`): `http://127.0.0.1:9000`.
- Override via CLI: `python -m src.langgraph_workflow.app --preset ci.test --host 0.0.0.0 --port 8080`.
- `FRONTEND_BASE_URL` is injected into allowed CORS origins during `_apply_runtime_config`.

## Authentication & Headers

- No authentication layer is currently enforced. Self-hosted deployments should place MoneyBot behind an authenticated reverse proxy.
- All REST endpoints accept and return JSON.
- WebSocket connections require no additional headers beyond standard handshake.

## WebSocket Channel

`GET /ws/portfolio/{portfolio_id}`

- Accepts a dedicated connection per portfolio id.
- Sends serialized `MessagePayload` structures.
- Keeps the connection alive via server-side pings (`WS_PING_INTERVAL`, `WS_PING_TIMEOUT`).
- Client responsibilities:
  - Maintain a heartbeat or respond promptly to avoid disconnects.
  - Buffer messages and display them chronologically (state updates, allocations, awaiting prompts).
  - Close gracefully after receiving `EndAnalysis` or when user cancels.

## Analysis Workflow Endpoints

### `POST /analysis/portfolio/{portfolio_id}/start`

Starts an analysis run using the current configuration for `portfolio_id`.

- **Prerequisites**: Active WebSocket for the same portfolio; portfolio file exists under `data/portfolios`.
- **Request body**: Empty JSON `{}` (ignored).
- **Response**: `HttpResponse` with `err_code` and optional `details`.
- **Failure codes**:
  - `400` – Missing WebSocket connection, missing portfolio, or validation errors.
  - `408` – WebSocket disconnect mid-run.
  - `500` – Unexpected runtime errors.

### `POST /analysis/portfolio/{portfolio_id}/respond`

Sends user responses back into the workflow.

- **Request body**: JSON string representing `MessagePayload`. Use the helper below to build payloads safely: `MessagePayload(data=ChoiceResponse(selection="confirm")).to_json()`.
- **Behavior**:
  - Validates that the workflow is awaiting input (`state['app_data']['awaiting']`).
  - Ensures response type matches the expected schema (choice, message, allocation).
  - Updates `PERSISTENT_USER_STATE` and reinvokes the LangGraph workflow.
- **Typical payloads**:

```json
{"data":{"type":"choice_response","selection":"confirm"}}
```

```json
{"data":{"type":"message_response","content":"Please incorporate more defensive stocks."}}
```

```json
{"data":{"type":"allocation_response","content":{"AAPL":10.0,"MSFT":5.0},"values":"shares"}}
```

- **Responses**: `HttpResponse` with `err_code=200` on success, `400` or `500` on validation or runtime errors.

## Utility Endpoints

### `POST /utils/load_portfolio_data`

- **Request**: `PortfolioDataRequest` with `portfolio_id`.
- **Response**: `LoadPortfolioDataResponse` containing the stored portfolio definition.
- **Failure**: `404` when portfolio is missing.

### `POST /utils/edit_portfolio`

- **Request**: `EditPortfolioRequest` with typed fields.
- **Validation**:
  - Budget must be non-negative integer.
  - Target date format `YYYY-MM-DD`.
  - Holdings dictionary of floats.
  - Risk tolerance (`low|medium|high`), criteria (`sector|market|score|market_cap`), prediction strength (`weak|medium|strong`).
- **Response**: `HttpResponse` with `err_code=200` on success.

### `POST /utils/create_portfolio`

- Wrapper around `edit_portfolio` that rejects duplicates (err_code `400`).

### `DELETE /utils/delete_portfolio`

- **Request**: `DeletePortfolioRequest` with `portfolio_id`.
- **Response**: `HttpResponse` with `err_code=200` when deletion succeeds.

### `GET /utils/list_portfolios`

- Returns `ListPortfoliosResponse` listing filenames (without extensions).
- `404` if no portfolios exist.

### `POST /utils/get_shares_price`

- **Request**: `GetSharesPriceRequest` supporting single ticker/amount or parallel lists.
- **Response**: `GetSharesPriceResponse` with converted price values.
- **Warning**: Reaches out to Yahoo Finance for fresh data; tests mock or skip this endpoint when network access is restricted.

### `POST /utils/validate_currency`

- Validates ISO currency codes via Pydantic `Currency` type.

## Message Payload Schema

The workflow communicates through `MessagePayload` envelopes. Payload types include:

- `state_update`
- `awaiting_choice`
- `awaiting_message`
- `awaiting_allocation`
- `choice_response`
- `message_response`
- `allocation_response`
- `end_analysis`

Use `MessagePayload.export_json_schema()` during development to keep frontend DTOs current. Section 13 of `src/webapp/plan.md` tracks mapping parity; remember to update it whenever this schema evolves.

## CORS & Origins

- Preset-driven allow list ensures the local Vite dev server (`http://127.0.0.1:5173`) stays permitted.
- Additional origins can be appended in custom presets under `server.cors.allow_origins`.

## Error Model

- All REST endpoints unify on `HttpResponse` with `err_code` and `details`.
- WebSocket errors propagate as JSON `state_update` entries before the server drops the connection.
- JSON bodies intentionally avoid raising raw FastAPI HTTP exceptions to keep frontend parsing simple.

## Rate Limiting & External Dependencies

- External services (NewsData, Yahoo Finance, GPU-based models) are optional:
  - When environment variables or GPU capability are missing, workflows skip heavy operations and fall back to cached data or CPU-safe modes.
  - Tests that require these services are gated by markers (`external`, `gpu`).
- `.env` and preset values determine which providers are enabled; see `docs/developer_guide.md` for details.

## Change Management Checklist

Whenever you add or modify endpoints:

1. Update this document with new parameters and behavior.
2. Sync DTO definitions with `src/webapp/src/types/api.ts` and document changes in Section 13 of `src/webapp/plan.md`.
3. Add or adjust tests under `tests/integration/` or `tests/e2e/`.
4. Cross-link any new workflows in `docs/architecture.md`.

Consistent documentation ensures MoneyBot’s API remains approachable for contributors and consumers. Keep response examples current and add regression tests for new flows.
